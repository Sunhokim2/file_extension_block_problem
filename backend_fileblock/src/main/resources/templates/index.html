<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파일 확장자 차단 설정</title>
</head>
<body>

<h1>파일 확장자 차단 설정</h1>

<div th:if="${successMessage}" style="color: green;" th:text="${successMessage}"></div>
<div th:if="${errorMessage}" style="color: red;" th:text="${errorMessage}"></div>


<div>
    <h2>고정 확장자</h2>
    <p>자주 사용되는 위험 확장자 목록입니다. 체크 시 차단됩니다.</p>
    <div>
        <label th:each="ext : ${fixedExtensions}">
            <input type="checkbox"
                   th:value="${ext.name}"
                   th:checked="${ext.isChecked()}"
                   onchange="updateFixed(this)">
            <span th:text="${ext.name}">.exe</span>
            </Ilabel>
    </div>
</div>


<div>
    <h2>커스텀 확장자</h2>
    <p>차단할 확장자를 직접 입력하세요 (최대 20자, 영문/숫자).</p>

    <form th:action="@{/custom/add}" th:object="${newCustomExtension}" method="post">
        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

        <div>
            <input type="text" th:field="*{name}" placeholder="예: zip" maxlength="20">
            <button type="submit">저장</button>
            <div th:if="${#fields.hasErrors('name')}"
                 th:errors="*{name}"
                 style="color: red; font-size: 0.9em;">
            </div>
        </div>
    </form>

    <div>
        <span th:text="${currentCustomCount}">0</span> / 200 개
    </div>

    <ul th:unless="${customExtensions.isEmpty()}">
        <li th:each="ext : ${customExtensions}">
            <span th:text="'.' + ${ext.name}">.zip</span>

            <form th:action="@{/custom/delete/{id}(id=${ext.id})}" method="post" style="display: inline;">
                <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                <button typeD="submit" title="삭제">X</button>
            </form>
        </li>
    </ul>
    <div th:if="${customExtensions.isEmpty()}">
        <p>등록된 커스텀 확장자가 없습니다.</p>
    </div>
</div>
<div>
    <h2>파일 업로드 테스트</h2>
    <p>설정한 차단 목록이 실제 업로드 시 동작하는지 테스트합니다.</p>

    <!--
      - enctype="multipart/form-data" : 파일 전송 폼 필수 속성
      - id="uploadForm" : JavaScript가 이 폼을 제어하기 위해 사용
    -->
    <form id="uploadForm" th:action="@{/upload}" method="post" enctype="multipart/form-data">
        <!-- CSRF 토큰 -->
        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

        <input type="file" id="fileUpload" name="fileUpload" required>
        <button type="submit">업로드 테스트</button>
    </form>

    <!-- AJAX 업로드 결과가 표시될 영역 -->
    <div id="uploadResult" style="margin-top: 1rem; font-weight: bold;"></div>
</div>

<script th:inline="javascript">
    /* CSRF 토큰을 JavaScript에서 사용하기 위해 변수화 */
    const csrfToken = /*[[${_csrf?.token}]]*/ null;
    const csrfHeader = /*[[${_csrf?.headerName}]]*/ null;

    /**
     * 고정 확장자 체크박스 상태 변경 시 AJAX POST 요청
     */
    function updateFixed(checkbox) {
        const extensionName = checkbox.value;
        const isBlocked = checkbox.checked;

        console.log(`Updating: ${extensionName}, Blocked: ${isBlocked}`);

        const headers = {
            'Content-Type': 'application/x-www-form-urlencoded'
        };

        // CSRF 토큰이 있으면 헤더에 추가
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        fetch('/fixed/update', {
            method: 'POST',
            headers: headers,
            body: new URLSearchParams({
                'name': extensionName,
                'blocked': isBlocked
            })
        })
            .then(response => {
                if (!response.ok) {
                    console.error('Failed to update extension.');
                    alert('확장자 상태 업데이트에 실패했습니다.');
                    checkbox.checked = !isBlocked; // 실패 시 UI 원상 복구
                } else {
                    console.log('Update successful.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('네트워크 오류가 발생했습니다.');
                checkbox.checked = !isBlocked; // 실패 시 UI 원상 복구
            });
    }

    document.getElementById('uploadForm').addEventListener('submit', async function(event) {
        // 1. 폼의 기본 제출(새로고침) 동작을 막음
        event.preventDefault();

        const form = event.target;
        const fileInput = document.getElementById('fileUpload');
        const resultDiv = document.getElementById('uploadResult');

        // 파일이 선택되었는지 확인
        if (!fileInput.files || fileInput.files.length === 0) {
            resultDiv.textContent = '파일을 선택해주세요.';
            resultDiv.style.color = 'red';
            return;
        }

        // 2. 폼 데이터를 FormData 객체로 생성
        const formData = new FormData(form);

        // CSRF 헤더 준비
        const headers = {};
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        try {
            // 3. fetch API로 파일 전송
            const response = await fetch(form.action, {
                method: 'POST',
                headers: headers,
                body: formData
            });

            // 4. 응답(텍스트)을 받음
            const message = await response.text();

            // 5. 응답 상태(response.ok)에 따라 메시지 표시
            if (response.ok) {
                // 성공 (200 OK)
                resultDiv.textContent = message;
                resultDiv.style.color = 'green';
            } else {
                // 실패 (400 Bad Request 등)
                resultDiv.textContent = message;
                resultDiv.style.color = 'red';
            }

        } catch (error) {
            console.error('Upload Error:', error);
            resultDiv.textContent = '업로드 중 네트워크 오류가 발생했습니다.';
            resultDiv.style.color = 'red';
        }

        // (중요) 다음 업로드를 위해 파일 입력 필드 초기화
        fileInput.value = null;
    });
</script>

</body>
</html>